---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import ProtectedRoute from '../components/ProtectedRoute.astro';
import '../styles/nuevo-proyecto.css';

const pageTitle = 'Nuevo Tablero';
---

<BaseLayout title={pageTitle}>
  <ProtectedRoute>
    <Header />
    <div class="container">
    <div class="nuevo-proyecto-container">
      <div class="proyecto-card">
        <div class="card-header">
          <h1>Crear Nuevo Tablero</h1>
          <p>Completa los campos para crear un nuevo tablero de trabajo</p>
        </div>

        <form id="proyecto-form" class="proyecto-form">
          <div class="form-group">
            <label for="nombre">Nombre del Tablero *</label>
            <input
              type="text"
              id="nombre"
              name="nombre"
              placeholder="Ej: App Web Tienda"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="anio">A√±o *</label>
              <select id="anio" name="anio" required>
                <option value="">Selecciona un a√±o</option>
              </select>
            </div>

            <div class="form-group">
              <label for="mes">Mes *</label>
              <select id="mes" name="mes" required>
                <option value="">Selecciona un mes</option>
                <option value="1">Enero</option>
                <option value="2">Febrero</option>
                <option value="3">Marzo</option>
                <option value="4">Abril</option>
                <option value="5">Mayo</option>
                <option value="6">Junio</option>
                <option value="7">Julio</option>
                <option value="8">Agosto</option>
                <option value="9">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="tipo_proyecto">Tipo de Tablero *</label>
            <select id="tipo_proyecto" name="tipo_proyecto" required>
              <option value="personal">Trabajo Personal</option>
              <option value="empleados">Con Empleados</option>
            </select>
          </div>

          <div id="empleados-container" class="form-group" style="display: none;">
            <label>Empleados</label>
            <div id="empleados-list">
              <div class="empleado-item">
                <input type="text" class="empleado-input" placeholder="Nombre del empleado" maxlength="100" />
                <button type="button" class="btn-remove-empleado">Eliminar</button>
              </div>
            </div>
            <button type="button" id="add-empleado-btn" class="btn btn-secondary-outline">+ Agregar Empleado</button>
          </div>

          <!-- Sistema de Turnos -->
          <div class="form-section">
            <h3>‚è∞ Sistema de Horarios</h3>
            
            <div class="form-group">
              <label for="modo_horarios">Modo de Horarios *</label>
              <select id="modo_horarios" name="modo_horarios">
                <option value="corrido">De corrido (Entrada/Salida √∫nica)</option>
                <option value="turnos">Por turnos (Ma√±ana/Tarde)</option>
              </select>
            </div>

            <div class="form-group">
              <label>Horario Laboral (opcional - para c√°lculo de horas extras)</label>
              <div class="time-row">
                <div class="time-input-group">
                  <label for="horario_inicio">Desde</label>
                  <input type="time" id="horario_inicio" name="horario_inicio" />
                </div>
                <div class="time-input-group">
                  <label for="horario_fin">Hasta</label>
                  <input type="time" id="horario_fin" name="horario_fin" />
                </div>
              </div>
            </div>

            <div id="turnos-config" class="turnos-config" style="display: none;">
              <div class="turno-group">
                <h4>üåÖ Turno Ma√±ana</h4>
                <div class="time-row">
                  <div class="time-input-group">
                    <label for="turno_manana_inicio">Desde</label>
                    <input type="time" id="turno_manana_inicio" name="turno_manana_inicio" />
                  </div>
                  <div class="time-input-group">
                    <label for="turno_manana_fin">Hasta</label>
                    <input type="time" id="turno_manana_fin" name="turno_manana_fin" />
                  </div>
                </div>
              </div>

              <div class="turno-group">
                <h4>üåÜ Turno Tarde</h4>
                <div class="time-row">
                  <div class="time-input-group">
                    <label for="turno_tarde_inicio">Desde</label>
                    <input type="time" id="turno_tarde_inicio" name="turno_tarde_inicio" />
                  </div>
                  <div class="time-input-group">
                    <label for="turno_tarde_fin">Hasta</label>
                    <input type="time" id="turno_tarde_fin" name="turno_tarde_fin" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="descripcion">Descripci√≥n (Opcional)</label>
            <textarea
              id="descripcion"
              name="descripcion"
              placeholder="Describe el prop√≥sito del tablero..."
              rows="4"
            ></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
              Crear Tablero
            </button>
            <a href="/proyectos" class="btn btn-secondary btn-lg">
              Cancelar
            </a>
          </div>
        </form>

        <div id="success-message" class="alert alert-success" style="display: none;">
          ‚úì Tablero creado exitosamente
        </div>

        <div id="error-message" class="alert alert-error" style="display: none;">
          ‚úó Error al crear el tablero
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
</style>

<script>
  import { AuthService } from '../services/auth';
  import { ProyectoFormHandler } from '../handlers/nuevo-proyecto';

  // Verificar autenticaci√≥n
  if (!AuthService.isAuthenticated()) {
    window.location.href = '/login';
  }

  // Inicializar select de a√±os y meses
  ProyectoFormHandler.inicializarAnios();
  ProyectoFormHandler.inicializarMes();

  // Gesti√≥n de tipo de proyecto
  const tipoProyectoSelect = document.getElementById('tipo_proyecto') as HTMLSelectElement;
  const empleadosContainer = document.getElementById('empleados-container') as HTMLElement;
  const addEmpleadoBtn = document.getElementById('add-empleado-btn') as HTMLButtonElement;
  const empleadosList = document.getElementById('empleados-list') as HTMLElement;

  // Gesti√≥n de sistema de turnos
  const modoHorariosSelect = document.getElementById('modo_horarios') as HTMLSelectElement;
  const turnosConfig = document.getElementById('turnos-config') as HTMLElement;
  const sistemaHorariosSection = document.querySelector('.form-section') as HTMLElement;

  // Funci√≥n para verificar si mostrar sistema de turnos
  const actualizarVisibilidadTurnos = () => {
    const esEmpleados = tipoProyectoSelect.value === 'empleados';
    const esTurnos = modoHorariosSelect.value === 'turnos';
    
    // Mostrar secci√≥n de sistema de horarios solo si es con empleados
    if (esEmpleados) {
      sistemaHorariosSection.style.display = 'block';
      // Mostrar configuraci√≥n de turnos solo si es modo turnos
      if (esTurnos) {
        turnosConfig.style.display = 'block';
      } else {
        turnosConfig.style.display = 'none';
      }
    } else {
      sistemaHorariosSection.style.display = 'none';
      turnosConfig.style.display = 'none';
    }
  };

  tipoProyectoSelect?.addEventListener('change', () => {
    if (tipoProyectoSelect.value === 'empleados') {
      empleadosContainer.style.display = 'block';
    } else {
      empleadosContainer.style.display = 'none';
    }
    actualizarVisibilidadTurnos();
  });

  // Mostrar/ocultar configuraci√≥n de turnos
  modoHorariosSelect?.addEventListener('change', () => {
    actualizarVisibilidadTurnos();
  });

  // Inicializar visibilidad al cargar
  actualizarVisibilidadTurnos();

  // Agregar empleado
  addEmpleadoBtn?.addEventListener('click', () => {
    const empleadoItem = document.createElement('div');
    empleadoItem.className = 'empleado-item';
    empleadoItem.innerHTML = `
      <input type="text" class="empleado-input" placeholder="Nombre del empleado" maxlength="100" />
      <button type="button" class="btn-remove-empleado">Eliminar</button>
    `;
    empleadosList.appendChild(empleadoItem);

    // Agregar evento de eliminar
    const removeBtn = empleadoItem.querySelector('.btn-remove-empleado');
    removeBtn?.addEventListener('click', () => {
      empleadoItem.remove();
    });
  });

  // Eventos de eliminar para el primer empleado
  document.querySelector('.btn-remove-empleado')?.addEventListener('click', function(e) {
    const target = e.target as HTMLElement;
    target.closest('.empleado-item')?.remove();
  });

  // Manejo del formulario
  const form = document.getElementById('proyecto-form') as HTMLFormElement;
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const success = await ProyectoFormHandler.crearProyecto();
  });
</script>
    </div>
  </ProtectedRoute>
</BaseLayout>

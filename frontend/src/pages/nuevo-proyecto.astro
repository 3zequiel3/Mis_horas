---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import ProtectedRoute from '../components/ProtectedRoute.astro';
import '../styles/nuevo-proyecto.css';

const pageTitle = 'Nuevo Tablero';
---

<BaseLayout title={pageTitle}>
  <ProtectedRoute>
    <Header />
    <div class="container">
    <div class="nuevo-proyecto-container">
      <div class="proyecto-card">
        <div class="card-header">
          <h1>Crear Nuevo Tablero</h1>
          <p>Completa los campos para crear un nuevo tablero de trabajo</p>
        </div>

        <form id="proyecto-form" class="proyecto-form">
          <div class="form-group">
            <label for="nombre">Nombre del Tablero *</label>
            <input
              type="text"
              id="nombre"
              name="nombre"
              placeholder="Ej: App Web Tienda"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="anio">Año *</label>
              <select id="anio" name="anio" required>
                <option value="">Selecciona un año</option>
              </select>
            </div>

            <div class="form-group">
              <label for="mes">Mes *</label>
              <select id="mes" name="mes" required>
                <option value="">Selecciona un mes</option>
                <option value="1">Enero</option>
                <option value="2">Febrero</option>
                <option value="3">Marzo</option>
                <option value="4">Abril</option>
                <option value="5">Mayo</option>
                <option value="6">Junio</option>
                <option value="7">Julio</option>
                <option value="8">Agosto</option>
                <option value="9">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="tipo_proyecto">Tipo de Tablero *</label>
            <select id="tipo_proyecto" name="tipo_proyecto" required>
              <option value="personal">Trabajo Personal</option>
              <option value="empleados">Con Empleados</option>
            </select>
          </div>

          <div id="empleados-container" class="form-group" style="display: none;">
            <label>Empleados</label>
            <div id="empleados-list">
              <div class="empleado-item">
                <input type="text" class="empleado-input" placeholder="Nombre del empleado" maxlength="100" />
                <button type="button" class="btn-remove-empleado">Eliminar</button>
              </div>
            </div>
            <button type="button" id="add-empleado-btn" class="btn btn-secondary-outline">+ Agregar Empleado</button>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="horas_reales_activas" name="horas_reales_activas" />
              Activar Horas Reales (para proyectos con empleados)
            </label>
          </div>

          <div class="form-group">
            <label for="descripcion">Descripción (Opcional)</label>
            <textarea
              id="descripcion"
              name="descripcion"
              placeholder="Describe el propósito del tablero..."
              rows="4"
            ></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
              Crear Tablero
            </button>
            <a href="/proyectos" class="btn btn-secondary btn-lg">
              Cancelar
            </a>
          </div>
        </form>

        <div id="success-message" class="alert alert-success" style="display: none;">
          ✓ Tablero creado exitosamente
        </div>

        <div id="error-message" class="alert alert-error" style="display: none;">
          ✗ Error al crear el tablero
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
</style>

<script>
  import { AuthService } from '../services/auth';
  import { ProyectoFormHandler } from '../handlers/nuevo-proyecto';

  // Verificar autenticación
  if (!AuthService.isAuthenticated()) {
    window.location.href = '/login';
  }

  // Inicializar select de años y meses
  ProyectoFormHandler.inicializarAnios();
  ProyectoFormHandler.inicializarMes();

  // Gestión de tipo de proyecto
  const tipoProyectoSelect = document.getElementById('tipo_proyecto') as HTMLSelectElement;
  const empleadosContainer = document.getElementById('empleados-container') as HTMLElement;
  const addEmpleadoBtn = document.getElementById('add-empleado-btn') as HTMLButtonElement;
  const empleadosList = document.getElementById('empleados-list') as HTMLElement;

  tipoProyectoSelect?.addEventListener('change', () => {
    if (tipoProyectoSelect.value === 'empleados') {
      empleadosContainer.style.display = 'block';
    } else {
      empleadosContainer.style.display = 'none';
    }
  });

  // Agregar empleado
  addEmpleadoBtn?.addEventListener('click', () => {
    const empleadoItem = document.createElement('div');
    empleadoItem.className = 'empleado-item';
    empleadoItem.innerHTML = `
      <input type="text" class="empleado-input" placeholder="Nombre del empleado" maxlength="100" />
      <button type="button" class="btn-remove-empleado">Eliminar</button>
    `;
    empleadosList.appendChild(empleadoItem);

    // Agregar evento de eliminar
    const removeBtn = empleadoItem.querySelector('.btn-remove-empleado');
    removeBtn?.addEventListener('click', () => {
      empleadoItem.remove();
    });
  });

  // Eventos de eliminar para el primer empleado
  document.querySelector('.btn-remove-empleado')?.addEventListener('click', function(e) {
    const target = e.target as HTMLElement;
    target.closest('.empleado-item')?.remove();
  });

  // Manejo del formulario
  const form = document.getElementById('proyecto-form') as HTMLFormElement;
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const success = await ProyectoFormHandler.crearProyecto();
  });
</script>
    </div>
  </ProtectedRoute>
</BaseLayout>

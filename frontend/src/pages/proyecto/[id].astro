---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import ProtectedRoute from '../../components/ProtectedRoute.astro';
import '../../styles/proyecto.css';
import '../../styles/tabla.css';
import '../../styles/tareas.css';
import '../../styles/modales.css';
import '../../styles/sidebar-meses.css';

const pageTitle = 'Proyecto - Mis Horas';

// Los handlers y servicios se importan en el script
---

<BaseLayout title={pageTitle}>
  <ProtectedRoute>
    <Header />
    <div class="container">
    <div class="proyecto-view">
      <!-- Header del Proyecto -->
      <div class="proyecto-header">
        <div>
          <h1 id="proyecto-nombre">Cargando...</h1>
          <p id="proyecto-periodo" class="proyecto-periodo"></p>
        </div>
        <div class="header-actions">
          <span id="proyecto-status" class="badge"></span>
          <button id="ver-todo-btn" class="btn btn-primary-outline">üìÖ Ver Todo el Mes</button>
          <button id="finalizar-btn" class="btn btn-success">‚úÖ Finalizar</button>
        </div>
      </div>

      <!-- Contenido Principal con Sidebar -->
      <div class="proyecto-wrapper">
        <!-- Sidebar de Meses -->
        <aside class="meses-sidebar">
          <div class="sidebar-header">
            <h3>üìÖ Meses</h3>
            <p id="proyecto-nombre-sidebar">Cargando...</p>
          </div>

          <button class="add-mes-btn" id="add-mes-btn">+ Agregar mes</button>

          <div class="meses-list" id="meses-list">
            <div class="mes-item loading">Cargando meses...</div>
          </div>

          <div class="mes-info" id="mes-info" style="display: none;">
            <strong>Mes actual:</strong> <span id="mes-info-text"></span>
          </div>
        </aside>

        <!-- Contenido Principal (Tabla + Panel de Tareas) -->
        <div class="proyecto-grid">
        <!-- Columna Izquierda: Tabla de D√≠as -->
        <div class="dias-column">
          <div class="section">
            <h2>üìÜ Esta Semana</h2>
            
            <div class="table-container">
              <table class="dias-table" id="dias-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>D√≠a</th>
                    <th>Horas Trabajadas</th>
                    <th id="th-horas-reales">Horas Reales</th>
                  </tr>
                </thead>
                <tbody id="dias-tbody">
                  <tr class="loading-row">
                    <td colspan="4" class="text-center">Cargando d√≠as...</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="totals-row">
                    <td><strong>Total:</strong></td>
                    <td></td>
                    <td><strong id="total-trabajadas">00:00</strong></td>
                    <td id="td-total-reales"><strong id="total-reales">00:00</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Panel de Tareas -->
        <div class="tareas-column">
          <!-- Tarjeta de Proyecto -->
          <div class="section proyecto-card-info">
            <h3 id="card-nombre">ArgentinaMining</h3>
            <p id="card-descripcion" class="card-descripcion">Sin descripci√≥n</p>
            <div class="card-badge">
              <span id="card-status" class="badge badge-active">‚úì Activo</span>
            </div>
          </div>

          <!-- Panel de Tareas -->
          <div class="section tareas-panel">
            <div class="tareas-header">
              <h2>üìã Tareas <span id="tareas-count" class="tareas-badge">0</span></h2>
              <button id="nueva-tarea-btn" class="btn btn-small">+ Nueva tarea</button>
            </div>

            <!-- Lista de Tareas -->
            <div id="tareas-list" class="tareas-list">
              <div class="empty-tareas">
                <p>üì≠ Sin tareas a√∫n</p>
              </div>
            </div>
          </div>

          <!-- Totales -->
          <div class="section totales-panel">
            <div class="total-item">
              <span>Total Horas Reales:</span>
              <strong id="panel-total-reales" class="total-value">06:00</strong>
            </div>
          </div>

          <!-- Bot√≥n Exportar -->
          <button id="exportar-pdf-btn" class="btn btn-danger btn-block">
            üì• Exportar PDF
          </button>
        </div>
      </div>
      </div>

      <!-- Modal para agregar mes -->
      <div class="add-mes-modal" id="add-mes-modal">
        <form class="add-mes-form" id="add-mes-form">
          <h3>Agregar Nuevo Mes</h3>
          
          <div class="form-group">
            <label for="nuevo-mes-year">A√±o:</label>
            <input type="number" id="nuevo-mes-year" min="2020" max="2100" required />
          </div>

          <div class="form-group">
            <label for="nuevo-mes-mes">Mes:</label>
            <select id="nuevo-mes-mes" required>
              <option value="">Seleccione un mes</option>
              <option value="1">Enero</option>
              <option value="2">Febrero</option>
              <option value="3">Marzo</option>
              <option value="4">Abril</option>
              <option value="5">Mayo</option>
              <option value="6">Junio</option>
              <option value="7">Julio</option>
              <option value="8">Agosto</option>
              <option value="9">Septiembre</option>
              <option value="10">Octubre</option>
              <option value="11">Noviembre</option>
              <option value="12">Diciembre</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Agregar</button>
            <button type="button" class="btn-secondary" id="close-add-mes">Cancelar</button>
          </div>
        </form>
      </div>
      <div id="mes-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
          <div class="modal-header">
            <h3 id="mes-modal-title">Noviembre 2025</h3>
            <button class="modal-close" id="mes-modal-close">‚úï</button>
          </div>
          <div class="selection-controls-container" id="mes-section-selection-controls" style="display: none;">
            <div class="selection-info">
              <span class="selection-count" id="mes-section-selection-count">0 d√≠as seleccionados</span>
            </div>
            <div class="selection-actions">
              <button class="selection-btn selection-btn-create" id="mes-section-btn-create-task">
                ‚úÖ Crear tarea
              </button>
              <button class="selection-btn selection-btn-cancel" id="mes-section-btn-cancel">
                ‚úñ Cancelar
              </button>
            </div>
          </div>
          <div class="mes-modal-body">
            <div class="table-container">
              <table class="dias-table" id="mes-dias-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>D√≠a</th>
                    <th>Horas Trabajadas</th>
                    <th>Horas Reales</th>
                  </tr>
                </thead>
                <tbody id="mes-dias-tbody">
                  <tr class="loading-row">
                    <td colspan="4" class="text-center">Cargando d√≠as...</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="totals-row">
                    <td><strong>Total del Mes:</strong></td>
                    <td></td>
                    <td><strong id="mes-total-trabajadas">00:00</strong></td>
                    <td><strong id="mes-total-reales">00:00</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="mes-modal-close-btn">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal para visualizar tarea -->
      <div id="view-tarea-modal" class="modal" style="display: none;">
        <div class="modal-content modal-tarea">
          <div class="modal-header">
            <h3 id="view-modal-title">Detalle de Tarea</h3>
            <button class="modal-close" id="view-modal-close">‚úï</button>
          </div>
          <div class="modal-body" id="view-modal-body">
            <!-- Contenido din√°mico -->
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" id="edit-from-view-btn">‚úèÔ∏è Editar</button>
            <button class="btn btn-danger" id="delete-from-view-btn">üóëÔ∏è Eliminar</button>
            <button class="btn btn-secondary" id="view-modal-close-btn">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal para nueva tarea -->
      <div id="tarea-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-title">Nueva Tarea</h3>
            <button class="modal-close" id="modal-close">‚úï</button>
          </div>
          <form id="tarea-form">
            <div class="form-group">
              <label>T√≠tulo *</label>
              <input type="text" id="tarea-titulo" required />
            </div>
            <div class="form-group">
              <label>Detalle</label>
              <textarea id="tarea-detalle" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>¬øQu√© falta?</label>
              <textarea id="tarea-que-falta" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Seleccionar D√≠as</label>
              <div class="dias-selector">
                <div id="dias-selected" class="dias-selected"></div>
                <select id="dias-select" class="dias-select">
                  <option value="">Seleccione los d√≠as</option>
                </select>
                
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Crear Tarea</button>
              <button type="button" class="btn btn-secondary" id="modal-cancel">Cancelar</button>
            </div>
          </form>
        </div>
      </div>

      <div id="error-message" class="alert alert-error" style="display: none;"></div>
    </div>
  </div>
</BaseLayout>



<script>
  import { AuthService } from '../../services/auth';
  import { ProyectoService } from '../../services/proyecto';
  import { proyectoHandlers } from '../../handlers/proyecto';
  import { TareaService } from '../../services/tarea';
  import { generateTasksPDF } from '../../utils/pdf';
  import { MESES_ES } from '../../utils/formatters';
  import { AlertUtils } from '../../utils/swal';
  import { TareaHandler } from '../../handlers/tarea';
  import { MesesHandler } from '../../handlers/meses';

  // Verificar autenticaci√≥n
  if (!AuthService.isAuthenticated()) {
    window.location.href = '/login';
  }

  // Exponer handlers globalmente
  (window as any).proyectoHandlers = proyectoHandlers;

  // Referencias a modales y elementos
  const modal = document.getElementById('tarea-modal')!;
  const mesModal = document.getElementById('mes-modal')!;
  const form = document.getElementById('tarea-form') as HTMLFormElement;
  const diasSelect = document.getElementById('dias-select') as HTMLSelectElement;
  const diasSelectedDiv = document.getElementById('dias-selected')!;

  // ========== GESTI√ìN DE TAREAS ==========

  // Nueva tarea
  document.getElementById('nueva-tarea-btn')?.addEventListener('click', async () => {
    TareaHandler.resetParaCrear(form);
    const proyecto = proyectoHandlers.state.proyectoActual;
    if (proyecto) {
      await TareaHandler.loadDiasDisponibles(proyecto.id, proyecto.anio, proyecto.mes);
    }
    modal.style.display = 'flex';
  });

  // Cerrar modales de tareas
  document.getElementById('modal-close')?.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  document.getElementById('modal-cancel')?.addEventListener('click', () => {
    modal.style.display = 'none';
  });
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = 'none';
  });

  // Seleccionar d√≠as
  diasSelect.addEventListener('change', () => {
    if (diasSelect.value) {
      const diaId = parseInt(diasSelect.value);
      const dia = TareaHandler.diasDisponibles.get(diaId);
      if (dia) {
        TareaHandler.diasSeleccionados.set(diaId, dia);
        TareaHandler.actualizarSelectDias(diasSelect);
        TareaHandler.renderizarDiasSeleccionados(diasSelectedDiv);
        diasSelect.value = '';
      }
    }
  });

  // Guardar tarea (crear o actualizar)
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const proyecto = proyectoHandlers.state.proyectoActual;
    if (proyecto) {
      const success = await TareaHandler.guardarTarea(form, proyecto.id, async () => {
        modal.style.display = 'none';
        TareaHandler.diasSeleccionados.clear();
        await proyectoHandlers.loadTareas();
      });
      if (success) {
        TareaHandler.renderizarDiasSeleccionados(diasSelectedDiv);
      }
    }
  });

  // Visualizar tarea
  document.addEventListener('view-tarea', (event: any) => {
    const tarea = event.detail.tarea;
    TareaHandler.tareaEnVista = tarea;
    const usaHorasReales = proyectoHandlers.state.usuarioActual?.usar_horas_reales || false;
    TareaHandler.renderizarVistaDetalle(tarea, usaHorasReales);
    document.getElementById('view-tarea-modal')!.style.display = 'flex';
  });

  // Cerrar modal de visualizaci√≥n
  document.getElementById('view-modal-close')?.addEventListener('click', () => {
    document.getElementById('view-tarea-modal')!.style.display = 'none';
  });
  document.getElementById('view-modal-close-btn')?.addEventListener('click', () => {
    document.getElementById('view-tarea-modal')!.style.display = 'none';
  });

  // Editar desde visualizaci√≥n
  document.getElementById('edit-from-view-btn')?.addEventListener('click', async () => {
    document.getElementById('view-tarea-modal')!.style.display = 'none';
    if (TareaHandler.tareaEnVista) {
      const proyecto = proyectoHandlers.state.proyectoActual;
      if (proyecto) {
        await TareaHandler.cargarParaEditar(
          TareaHandler.tareaEnVista,
          proyecto.id,
          proyecto.anio,
          proyecto.mes
        );
        modal.style.display = 'flex';
      }
    }
  });

  // Crear tarea con d√≠as pre-seleccionados desde multi-select
  document.addEventListener('create-tarea-with-dias', async (event: any) => {
    const diaIds = event.detail.diaIds as number[];
    const proyecto = proyectoHandlers.state.proyectoActual;
    if (proyecto && diaIds && diaIds.length > 0) {
      // Cargar d√≠as disponibles
      await TareaHandler.loadDiasDisponibles(
        proyecto.id,
        proyecto.anio,
        proyecto.mes
      );
      
      // Resetear formulario con d√≠as pre-seleccionados
      TareaHandler.resetParaCrear(form, diaIds);
      
      // Abrir modal
      modal.style.display = 'flex';
    }
  });

  // Eliminar desde visualizaci√≥n
  document.getElementById('delete-from-view-btn')?.addEventListener('click', async () => {
    if (TareaHandler.tareaEnVista) {
      document.getElementById('view-tarea-modal')!.style.display = 'none';
      await TareaHandler.eliminarTarea(
        TareaHandler.tareaEnVista.id,
        TareaHandler.tareaEnVista.titulo,
        async () => {
          await proyectoHandlers.loadTareas();
        }
      );
    }
  });

  // ========== GESTI√ìN DE MESES ==========

  // Modal de mes (ver todo)
  document.getElementById('ver-todo-btn')?.addEventListener('click', () => {
    const proyecto = proyectoHandlers.state.proyectoActual;
    if (proyecto) {
      const mesModalTitle = document.getElementById('mes-modal-title');
      if (mesModalTitle) {
        const mesNombre = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][proyecto.mes - 1];
        mesModalTitle.textContent = `${mesNombre} ${proyecto.anio}`;
      }
    }
    mesModal.style.display = 'flex';
  });

  document.getElementById('mes-modal-close')?.addEventListener('click', () => {
    mesModal.style.display = 'none';
  });

  document.getElementById('mes-modal-close-btn')?.addEventListener('click', () => {
    mesModal.style.display = 'none';
  });

  mesModal.addEventListener('click', (e) => {
    if (e.target === mesModal) mesModal.style.display = 'none';
  });

  // Agregar mes
  document.getElementById('add-mes-btn')?.addEventListener('click', () => {
    MesesHandler.openAddMesModal();
  });

  document.getElementById('close-add-mes')?.addEventListener('click', () => {
    MesesHandler.closeAddMesModal();
  });

  document.getElementById('add-mes-modal')?.addEventListener('click', (e) => {
    if (e.target === document.getElementById('add-mes-modal')) {
      MesesHandler.closeAddMesModal();
    }
  });

  // Formulario agregar mes
  document.getElementById('add-mes-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const anio = parseInt((document.getElementById('nuevo-mes-year') as HTMLInputElement).value);
      const mes = parseInt((document.getElementById('nuevo-mes-mes') as HTMLSelectElement).value);

      if (!anio || !mes) {
        await AlertUtils.error('Error', 'Por favor seleccione un mes y a√±o v√°lidos');
        return;
      }

      const fechaSeleccionada = new Date(anio, mes - 1, 1);
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);

      if (fechaSeleccionada < hoy) {
        const result = await AlertUtils.question(
          '¬øDeseas continuar?',
          'La fecha seleccionada es anterior a hoy.'
        );
        if (result.isConfirmed) {
          const proyecto = proyectoHandlers.state.proyectoActual;
          if (proyecto) await MesesHandler.agregarMes(proyecto.id, anio, mes);
        }
      } else {
        const proyecto = proyectoHandlers.state.proyectoActual;
        if (proyecto) await MesesHandler.agregarMes(proyecto.id, anio, mes);
      }
    } catch (error) {
      console.error('Error:', error);
      await AlertUtils.error('Error', 'No se pudo agregar el mes');
    }
  });

  // Evento cuando se selecciona un mes
  document.addEventListener('mes-selected', async (event: any) => {
    const { anio, mes } = event.detail;
    const proyecto = proyectoHandlers.state.proyectoActual;

    if (proyecto) {
      const mesCreado = await MesesHandler.crearMesAutomatico(proyecto.id, anio, mes);

      if (!mesCreado) {
        await AlertUtils.error('Error', 'No se pudo crear el mes autom√°ticamente');
        return;
      }

      // Actualizar proyecto
      proyecto.anio = anio;
      proyecto.mes = mes;
      proyectoHandlers.state.mesActual = mes;
      proyectoHandlers.state.anioActual = anio;

      // Recargar datos
      await proyectoHandlers.loadDias();
      await proyectoHandlers.loadTareas();
      proyectoHandlers.updateTotalPanel();

      // Actualizar UI
      const periodoEl = document.getElementById('proyecto-periodo');
      if (periodoEl) {
        periodoEl.textContent = `${MESES_ES[mes as keyof typeof MESES_ES]} ${anio}`;
      }

      MesesHandler.renderMeses({ anio, mes });
      MesesHandler.updateMesInfo({ anio, mes });
    }
  });

  // ========== ACCIONES GENERALES ==========

  // Exportar PDF
  document.getElementById('exportar-pdf-btn')?.addEventListener('click', async () => {
    try {
      const proyecto = proyectoHandlers.state.proyectoActual;
      if (!proyecto) {
        await AlertUtils.error('Error', 'Proyecto no disponible');
        return;
      }

      const mes = MESES_ES[proyecto.mes as keyof typeof MESES_ES] || `Mes ${proyecto.mes}`;
      const tareas = proyectoHandlers.state.tareasActuales;

      if (tareas.length === 0) {
        await AlertUtils.info('Informaci√≥n', 'No hay tareas para exportar');
        return;
      }

      AlertUtils.loading('Generando PDF...');
      try {
        await generateTasksPDF(
          proyecto.nombre,
          mes,
          proyecto.anio,
          tareas,
          proyectoHandlers.state.diasActuales
        );
        AlertUtils.close();
        await AlertUtils.success('√âxito', 'PDF descargado correctamente');
      } catch (error) {
        console.error('Error generando PDF:', error);
        AlertUtils.close();
        await AlertUtils.error('Error', 'No se pudo generar el PDF');
      }
    } catch (error) {
      console.error('Error:', error);
      await AlertUtils.error('Error', 'Error al exportar PDF');
    }
  });

  // Finalizar o Reactivar proyecto
  document.getElementById('finalizar-btn')?.addEventListener('click', async () => {
    const proyecto = proyectoHandlers.state.proyectoActual;
    if (!proyecto) return;

    const isActive = proyecto.activo;
    const action = isActive ? 'Finalizar' : 'Reactivar';

    const result = await AlertUtils.confirm(
      `¬ø${action} proyecto?`,
      isActive
        ? 'Esto marcar√° el proyecto como inactivo'
        : 'Esto reactivar√° el proyecto',
      `S√≠, ${action.toLowerCase()}`,
      'Cancelar'
    );

    if (result.isConfirmed) {
      try {
        await ProyectoService.cambiarEstado(proyecto.id, !isActive);
        await proyectoHandlers.loadProyecto();
        await AlertUtils.success('√âxito', `Proyecto ${action.toLowerCase()}do correctamente`);
      } catch (error) {
        await AlertUtils.error('Error', `No se pudo ${action.toLowerCase()} el proyecto`);
      }
    }
  });

  // ========== INICIALIZACI√ìN ==========

  // Inicializar al cargar la p√°gina
  proyectoHandlers.loadProyecto().then(async () => {
    const proyecto = proyectoHandlers.state.proyectoActual;
    if (proyecto) {
      // Cargar meses
      await MesesHandler.loadMeses(proyecto.id);
      MesesHandler.updateMesInfo({ anio: proyecto.anio, mes: proyecto.mes });

      // Actualizar nombre del sidebar
      const sidebarNombre = document.getElementById('proyecto-nombre-sidebar');
      if (sidebarNombre) sidebarNombre.textContent = proyecto.nombre;
    }
    
    // Inicializar modo de selecci√≥n m√∫ltiple
    proyectoHandlers.initMultiSelect();
  });

  // Limpiar al salir
  window.addEventListener('beforeunload', () => {
    proyectoHandlers.cleanupMultiSelect();
  });
</script>

    </div>
  </ProtectedRoute>
</BaseLayout>

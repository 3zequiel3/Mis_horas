---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import ProtectedRoute from '../../components/ProtectedRoute.astro';
import '../../styles/proyecto.css';
import '../../styles/tabla.css';
import '../../styles/tareas.css';
import '../../styles/modales.css';
import '../../styles/sidebar-meses.css';

const pageTitle = 'Proyecto - Mis Horas';
---

<BaseLayout title={pageTitle}>
  <ProtectedRoute>
    <Header />
    <div class="container">
    <div class="proyecto-view">
      <!-- Header del Proyecto -->
      <div class="proyecto-header">
        <div>
          <h1 id="proyecto-nombre">Cargando...</h1>
          <p id="proyecto-periodo" class="proyecto-periodo"></p>
        </div>
        <div class="header-actions">
          <span id="proyecto-status" class="badge"></span>
          <button id="ver-todo-btn" class="btn btn-primary-outline">üìÖ Ver Todo el Mes</button>
          <button id="finalizar-btn" class="btn btn-success">‚úÖ Finalizar</button>
        </div>
      </div>

      <!-- Contenido Principal con Sidebar -->
      <div class="proyecto-wrapper">
        <!-- Sidebar de Meses -->
        <aside class="meses-sidebar">
          <div class="sidebar-header">
            <h3>üìÖ Meses</h3>
            <p id="proyecto-nombre-sidebar">Cargando...</p>
          </div>

          <button class="add-mes-btn" id="add-mes-btn">+ Agregar mes</button>

          <div class="meses-list" id="meses-list">
            <div class="mes-item loading">Cargando meses...</div>
          </div>

          <div class="mes-info" id="mes-info" style="display: none;">
            <strong>Mes actual:</strong> <span id="mes-info-text"></span>
          </div>
        </aside>

        <!-- Contenido Principal (Tabla + Panel de Tareas) -->
        <div class="proyecto-grid">
        <!-- Columna Izquierda: Tabla de D√≠as -->
        <div class="dias-column">
          <div class="section">
            <h2>üìÜ Esta Semana</h2>
            
            <div class="table-container">
              <table class="dias-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>D√≠a</th>
                    <th>Horas Trabajadas</th>
                    <th id="th-horas-reales">Horas Reales</th>
                  </tr>
                </thead>
                <tbody id="dias-tbody">
                  <tr class="loading-row">
                    <td colspan="4" class="text-center">Cargando d√≠as...</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="totals-row">
                    <td><strong>Total:</strong></td>
                    <td></td>
                    <td><strong id="total-trabajadas">00:00</strong></td>
                    <td id="td-total-reales"><strong id="total-reales">00:00</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Panel de Tareas -->
        <div class="tareas-column">
          <!-- Tarjeta de Proyecto -->
          <div class="section proyecto-card-info">
            <h3 id="card-nombre">ArgentinaMining</h3>
            <p id="card-descripcion" class="card-descripcion">Sin descripci√≥n</p>
            <div class="card-badge">
              <span id="card-status" class="badge badge-active">‚úì Activo</span>
            </div>
          </div>

          <!-- Panel de Tareas -->
          <div class="section tareas-panel">
            <div class="tareas-header">
              <h2>üìã Tareas <span id="tareas-count" class="tareas-badge">0</span></h2>
              <button id="nueva-tarea-btn" class="btn btn-small">+ Nueva tarea</button>
            </div>

            <!-- Lista de Tareas -->
            <div id="tareas-list" class="tareas-list">
              <div class="empty-tareas">
                <p>üì≠ Sin tareas a√∫n</p>
              </div>
            </div>
          </div>

          <!-- Totales -->
          <div class="section totales-panel">
            <div class="total-item">
              <span>Total Horas Reales:</span>
              <strong id="panel-total-reales" class="total-value">06:00</strong>
            </div>
          </div>

          <!-- Bot√≥n Exportar -->
          <button id="exportar-pdf-btn" class="btn btn-danger btn-block">
            üì• Exportar PDF
          </button>
        </div>
      </div>
      </div>

      <!-- Modal para agregar mes -->
      <div class="add-mes-modal" id="add-mes-modal">
        <form class="add-mes-form" id="add-mes-form">
          <h3>Agregar Nuevo Mes</h3>
          
          <div class="form-group">
            <label for="nuevo-mes-year">A√±o:</label>
            <input type="number" id="nuevo-mes-year" min="2020" max="2100" required />
          </div>

          <div class="form-group">
            <label for="nuevo-mes-mes">Mes:</label>
            <select id="nuevo-mes-mes" required>
              <option value="">Seleccione un mes</option>
              <option value="1">Enero</option>
              <option value="2">Febrero</option>
              <option value="3">Marzo</option>
              <option value="4">Abril</option>
              <option value="5">Mayo</option>
              <option value="6">Junio</option>
              <option value="7">Julio</option>
              <option value="8">Agosto</option>
              <option value="9">Septiembre</option>
              <option value="10">Octubre</option>
              <option value="11">Noviembre</option>
              <option value="12">Diciembre</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Agregar</button>
            <button type="button" class="btn-secondary" id="close-add-mes">Cancelar</button>
          </div>
        </form>
      </div>
      <div id="mes-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
          <div class="modal-header">
            <h3 id="mes-modal-title">Todos los d√≠as de Noviembre 2025</h3>
            <button class="modal-close" id="mes-modal-close">‚úï</button>
          </div>
          <div class="mes-modal-body">
            <div class="table-container">
              <table class="dias-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>D√≠a</th>
                    <th>Horas Trabajadas</th>
                    <th>Horas Reales</th>
                  </tr>
                </thead>
                <tbody id="mes-dias-tbody">
                  <tr class="loading-row">
                    <td colspan="4" class="text-center">Cargando d√≠as...</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="totals-row">
                    <td><strong>Total del Mes:</strong></td>
                    <td></td>
                    <td><strong id="mes-total-trabajadas">00:00</strong></td>
                    <td><strong id="mes-total-reales">00:00</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="mes-modal-close-btn">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal para visualizar tarea -->
      <div id="view-tarea-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3 id="view-modal-title">Detalle de Tarea</h3>
            <button class="modal-close" id="view-modal-close">‚úï</button>
          </div>
          <div class="modal-body" id="view-modal-body">
            <!-- Contenido din√°mico -->
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" id="edit-from-view-btn">‚úèÔ∏è Editar</button>
            <button class="btn btn-danger" id="delete-from-view-btn">üóëÔ∏è Eliminar</button>
            <button class="btn btn-secondary" id="view-modal-close-btn">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal para nueva tarea -->
      <div id="tarea-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-title">Nueva Tarea</h3>
            <button class="modal-close" id="modal-close">‚úï</button>
          </div>
          <form id="tarea-form">
            <div class="form-group">
              <label>T√≠tulo *</label>
              <input type="text" id="tarea-titulo" required />
            </div>
            <div class="form-group">
              <label>Detalle</label>
              <textarea id="tarea-detalle" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>¬øQu√© falta?</label>
              <textarea id="tarea-que-falta" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Seleccionar D√≠as</label>
              <div class="dias-selector">
                <div id="dias-selected" class="dias-selected"></div>
                <select id="dias-select" class="dias-select">
                  <option value="">Seleccione los d√≠as</option>
                </select>
                
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Crear Tarea</button>
              <button type="button" class="btn btn-secondary" id="modal-cancel">Cancelar</button>
            </div>
          </form>
        </div>
      </div>

      <div id="error-message" class="alert alert-error" style="display: none;"></div>
    </div>
  </div>
</BaseLayout>



<script>
  import { AuthService } from '../../services/auth';
  import { ProyectoService } from '../../services/proyecto';
  import { proyectoHandlers } from '../../handlers/proyecto';
  import { TareaService } from '../../services/tarea';
  import { generateTasksPDF } from '../../utils/pdf';
  import { MESES_ES } from '../../utils/formatters';
  import Swal from 'sweetalert2';

  // Verificar autenticaci√≥n primero
  if (!AuthService.isAuthenticated()) {
    window.location.href = '/login';
  }

  // Exposer handlers globalmente
  (window as any).proyectoHandlers = proyectoHandlers;

  // Inicializar modales b√°sicos
  const modal = document.getElementById('tarea-modal')!;
  const mesModal = document.getElementById('mes-modal')!;
  const form = document.getElementById('tarea-form') as HTMLFormElement;
  const diasSelect = document.getElementById('dias-select') as HTMLSelectElement;
  const diasSelectedDiv = document.getElementById('dias-selected')!;

  // Estado para d√≠as seleccionados y disponibles
  let diasSeleccionados = new Map<number, { id: number; fecha: string; texto: string }>();
  let diasDisponibles = new Map<number, { id: number; fecha: string; texto: string }>();

  /**
   * Actualiza las opciones del select mostrando solo d√≠as no seleccionados
   */
  function actualizarSelectDias() {
    diasSelect.innerHTML = '<option value="">Seleccione los d√≠as</option>';

    diasDisponibles.forEach((dia) => {
      if (!diasSeleccionados.has(dia.id)) {
        const option = document.createElement('option');
        option.value = dia.id.toString();
        option.textContent = dia.texto;
        diasSelect.appendChild(option);
      }
    });
  }

  /**
   * Renderiza los d√≠as seleccionados
   */
  function renderizarDiasSeleccionados() {
    if (diasSeleccionados.size === 0) {
      diasSelectedDiv.innerHTML = '';
      return;
    }

    diasSelectedDiv.innerHTML = Array.from(diasSeleccionados.values())
      .map(
        (dia) => `
      <div class="dia-badge">
        <span>${dia.texto}</span>
        <button type="button" class="dia-remove" data-dia-id="${dia.id}">‚úï</button>
      </div>
    `
      )
      .join('');

    // Agregar event listeners a los botones de eliminar
    diasSelectedDiv.querySelectorAll('.dia-remove').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const diaId = parseInt((btn as HTMLElement).getAttribute('data-dia-id') || '0');
        diasSeleccionados.delete(diaId);
        actualizarSelectDias();
        renderizarDiasSeleccionados();
      });
    });
  }

  /**
   * Carga los d√≠as disponibles para la tarea
   */
  async function loadDiasDisponibles() {
    try {
      if (!proyectoHandlers.state.proyectoActual) return;

      const proyecto = proyectoHandlers.state.proyectoActual;
      const dias = await TareaService.getDiasDisponibles(
        proyecto.id,
        proyecto.anio,
        proyecto.mes
      );

      diasDisponibles.clear();
      diasSeleccionados.clear();

      // Crear mapa de d√≠as disponibles
      dias.forEach((dia: any) => {
        const fechaFormato = new Date(dia.fecha).toLocaleDateString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          weekday: 'short',
        });

        diasDisponibles.set(dia.id, {
          id: dia.id,
          fecha: dia.fecha,
          texto: fechaFormato,
        });
      });

      actualizarSelectDias();
      renderizarDiasSeleccionados();
    } catch (error) {
      console.error('Error cargando d√≠as:', error);
      diasSelect.innerHTML = '<option disabled>Error al cargar d√≠as</option>';
    }
  }

  // Event listeners del modal
  document.getElementById('nueva-tarea-btn')?.addEventListener('click', async () => {
    form.reset();
    diasSeleccionados.clear();
    
    // Resetear modal a modo creaci√≥n
    const modalTitle = document.getElementById('modal-title');
    const submitBtn = form.querySelector<HTMLButtonElement>('button[type="submit"]');
    if (modalTitle) modalTitle.textContent = 'Nueva Tarea';
    if (submitBtn) {
      submitBtn.textContent = 'Crear Tarea';
      submitBtn.dataset.editMode = 'false';
      submitBtn.dataset.tareaId = '0';
    }
    
    await loadDiasDisponibles();
    modal.style.display = 'flex';
  });

  // Cerrar modal de visualizaci√≥n
  document.getElementById('view-modal-close')?.addEventListener('click', () => {
    const viewModal = document.getElementById('view-tarea-modal')!;
    viewModal.style.display = 'none';
  });

  document.getElementById('view-modal-close-btn')?.addEventListener('click', () => {
    const viewModal = document.getElementById('view-tarea-modal')!;
    viewModal.style.display = 'none';
  });

  // Estado para tarea en visualizaci√≥n
  let tareaEnVista: any = null;

  // Evento para visualizar tarea
  document.addEventListener('view-tarea', async (event: any) => {
    const tarea = event.detail.tarea;
    tareaEnVista = tarea; // Guardar referencia
    const viewModal = document.getElementById('view-tarea-modal')!;
    const viewModalTitle = document.getElementById('view-modal-title');
    const viewModalBody = document.getElementById('view-modal-body');

    if (viewModalTitle) {
      viewModalTitle.textContent = tarea.titulo;
    }

    if (viewModalBody) {
      // Renderizar formulario editable con horas de cada d√≠a
      let diasHtml = '';
      if (tarea.dias && tarea.dias.length > 0) {
        diasHtml = tarea.dias
          .map((d: any) => {
            const fecha = new Date(d.fecha).toLocaleDateString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: '2-digit',
              weekday: 'short',
            });
            const horasAMostrar = proyectoHandlers.state.usuarioActual?.usar_horas_reales
              ? d.horas_reales || 0
              : d.horas_trabajadas || 0;
            return `
              <div class="dia-edit-row" data-dia-id="${d.id}">
                <label>${fecha}</label>
                <input 
                  type="text" 
                  class="dia-horas-input" 
                  value="${horasAMostrar}" 
                  placeholder="0:00"
                  data-tarea-id="${tarea.id}"
                  data-dia-id="${d.id}"
                />
              </div>
            `;
          })
          .join('');
      } else {
        diasHtml = '<p style="color: var(--text-secondary); text-align: center;">Sin d√≠as asignados</p>';
      }

      viewModalBody.innerHTML = `
        <div class="tarea-detalle">
          <div class="detalle-row">
            <strong>Detalle:</strong>
            <p>${tarea.detalle || 'Sin detalle'}</p>
          </div>
          <div class="detalle-row">
            <strong>¬øQu√© falta?</strong>
            <p>${tarea.que_falta || 'Nada pendiente'}</p>
          </div>
          <div class="detalle-row">
            <strong>Horas totales:</strong>
            <p>${tarea.horas}</p>
          </div>
          <div class="detalle-row">
            <strong>Editar horas por d√≠a:</strong>
            <div class="dias-edit-form">
              ${diasHtml}
            </div>
          </div>
        </div>
      `;

      // Agregar event listeners a los inputs de horas
      viewModalBody.querySelectorAll('.dia-horas-input').forEach((input: Element) => {
        const inputEl = input as HTMLInputElement;
        inputEl.addEventListener('change', async () => {
          const tareaId = parseInt(inputEl.dataset.tareaId || '0');
          const diaId = parseInt(inputEl.dataset.diaId || '0');
          const horasStr = inputEl.value;

          try {
            const tareaActualizada = await TareaService.updateTareaDiaHoras(
              tareaId,
              diaId,
              horasStr
            );

            // Actualizar la tarea en vista
            tareaEnVista = tareaActualizada;

            // Mostrar notificaci√≥n de √©xito
            Swal.fire({
              title: '‚úì',
              text: 'Horas actualizadas',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false,
              background: '#0f1419',
              color: '#c8c8c8',
              iconColor: '#10b981',
            });

            // Recargar tareas para reflejar los cambios
            await proyectoHandlers.loadTareas();
            await proyectoHandlers.loadDias();
          } catch (error) {
            console.error('Error actualizando horas:', error);
            Swal.fire({
              title: 'Error',
              text: 'No se pudieron actualizar las horas',
              icon: 'error',
              background: '#0f1419',
              color: '#c8c8c8',
              confirmButtonColor: '#ef4444',
              iconColor: '#ef4444',
            });
            // Revertir el input
            inputEl.value = inputEl.defaultValue;
          }
        });
      });
    }

    viewModal.style.display = 'flex';
  });

  // Evento para editar desde visualizaci√≥n
  document.getElementById('edit-from-view-btn')?.addEventListener('click', () => {
    const viewModal = document.getElementById('view-tarea-modal')!;
    
    if (tareaEnVista) {
      const event = new CustomEvent('edit-tarea', { detail: { tarea: tareaEnVista } });
      document.dispatchEvent(event);
      viewModal.style.display = 'none';
    }
  });

  // Evento para eliminar tarea desde visualizaci√≥n
  document.getElementById('delete-from-view-btn')?.addEventListener('click', async () => {
    if (!tareaEnVista) return;

    const result = await Swal.fire({
      title: '¬øEliminar tarea?',
      text: `Se eliminar√° la tarea "${tareaEnVista.titulo}" y sus d√≠as volver√°n a estar disponibles`,
      icon: 'warning',
      showCancelButton: true,
      background: '#0f1419',
      color: '#c8c8c8',
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#2d3746',
      confirmButtonText: 'S√≠, eliminar',
      cancelButtonText: 'Cancelar',
      iconColor: '#f59e0b',
    });

    if (result.isConfirmed) {
      try {
        await TareaService.deleteTarea(tareaEnVista.id);
        
        const viewModal = document.getElementById('view-tarea-modal')!;
        viewModal.style.display = 'none';
        
        Swal.fire({
          title: 'Eliminada',
          text: 'La tarea ha sido eliminada correctamente',
          icon: 'success',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#10b981',
          iconColor: '#10b981',
        });
        
        // Recargar tareas
        await proyectoHandlers.loadTareas();
      } catch (error) {
        console.error('Error eliminando tarea:', error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo eliminar la tarea',
          icon: 'error',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#ef4444',
          iconColor: '#ef4444',
        });
      }
    }
  });

  document.getElementById('modal-close')?.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  document.getElementById('modal-cancel')?.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = 'none';
  });

  // Manejar cambios en el select
  diasSelect.addEventListener('change', () => {
    if (diasSelect.value) {
      const diaId = parseInt(diasSelect.value);
      const dia = diasDisponibles.get(diaId);

      if (dia) {
        diasSeleccionados.set(diaId, dia);
        actualizarSelectDias();
        renderizarDiasSeleccionados();
        diasSelect.value = ''; // Resetear select
      }
    }
  });

  // Manejar env√≠o del formulario
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
      const titulo = (document.getElementById('tarea-titulo') as HTMLInputElement).value;
      const detalle = (document.getElementById('tarea-detalle') as HTMLTextAreaElement).value;
      const que_falta = (document.getElementById('tarea-que-falta') as HTMLTextAreaElement).value;
      const submitBtn = form.querySelector<HTMLButtonElement>('button[type="submit"]');
      const editMode = submitBtn?.dataset.editMode === 'true';
      const tareaId = parseInt(submitBtn?.dataset.tareaId || '0');

      if (!titulo.trim()) {
        Swal.fire({
          title: 'Error',
          text: 'El t√≠tulo es requerido',
          icon: 'error',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#ef4444',
          iconColor: '#ef4444',
        });
        return;
      }

      // Convertir d√≠as seleccionados a array (puede ser vac√≠o)
      const diasIds = Array.from(diasSeleccionados.keys());

      if (editMode && tareaId > 0) {
        // Actualizar tarea existente - siempre pasar dias_ids (incluso si es array vac√≠o)
        const tareaActualizada = await TareaService.updateTarea(
          tareaId,
          titulo,
          detalle,
          que_falta,
          diasIds  // Pasar array siempre (puede estar vac√≠o)
        );

        Swal.fire({
          title: '√âxito',
          text: 'Tarea actualizada correctamente',
          icon: 'success',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#10b981',
          iconColor: '#10b981',
        });
      } else {
        // Crear nueva tarea
        const nuevaTarea = await TareaService.createTarea(
          proyectoHandlers.state.proyectoActual?.id || 0,
          titulo,
          detalle,
          que_falta,
          diasIds.length > 0 ? diasIds : undefined  // Para crear, undefined si no hay d√≠as
        );

        Swal.fire({
          title: '√âxito',
          text: 'Tarea creada correctamente',
          icon: 'success',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#10b981',
          iconColor: '#10b981',
        });
      }

      modal.style.display = 'none';
      form.reset();
      diasSeleccionados.clear();
      diasSelectedDiv.innerHTML = '';

      // Resetear bot√≥n
      if (submitBtn) {
        submitBtn.textContent = 'Crear Tarea';
        submitBtn.dataset.editMode = 'false';
        submitBtn.dataset.tareaId = '0';
      }

      // Recargar tareas
      await proyectoHandlers.loadTareas();
    } catch (error) {
      console.error('Error con tarea:', error);
      Swal.fire({
        title: 'Error',
        text: 'No se pudo guardar la tarea',
        icon: 'error',
        background: '#0f1419',
        color: '#c8c8c8',
        confirmButtonColor: '#ef4444',
        iconColor: '#ef4444',
      });
    }
  });

  // Modal de mes
  document.getElementById('ver-todo-btn')?.addEventListener('click', () => {
    mesModal.style.display = 'flex';
  });

  document.getElementById('mes-modal-close')?.addEventListener('click', () => {
    mesModal.style.display = 'none';
  });

  document.getElementById('mes-modal-close-btn')?.addEventListener('click', () => {
    mesModal.style.display = 'none';
  });

  mesModal.addEventListener('click', (e) => {
    if (e.target === mesModal) mesModal.style.display = 'none';
  });

  // Exportar PDF
  document.getElementById('exportar-pdf-btn')?.addEventListener('click', async () => {
    try {
      const proyecto = proyectoHandlers.state.proyectoActual;
      if (!proyecto) {
        Swal.fire({
          title: 'Error',
          text: 'Proyecto no disponible',
          icon: 'error',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#ef4444',
          iconColor: '#ef4444',
        });
        return;
      }

      const mes = MESES_ES[proyecto.mes as keyof typeof MESES_ES] || `Mes ${proyecto.mes}`;
      const tareas = proyectoHandlers.state.tareasActuales;

      if (tareas.length === 0) {
        Swal.fire({
          title: 'Informaci√≥n',
          text: 'No hay tareas para exportar',
          icon: 'info',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#667eea',
          iconColor: '#667eea',
        });
        return;
      }

      // Mostrar alerta de carga
      Swal.fire({
        title: 'Generando PDF...',
        allowOutsideClick: false,
        background: '#0f1419',
        color: '#c8c8c8',
        didOpen: async () => {
          Swal.showLoading();
          try {
            await generateTasksPDF(proyecto.nombre, mes, proyecto.anio, tareas, proyectoHandlers.state.diasActuales);
            Swal.hideLoading();
            Swal.fire({
              title: '√âxito',
              text: 'PDF descargado correctamente',
              icon: 'success',
              background: '#0f1419',
              color: '#c8c8c8',
              confirmButtonColor: '#10b981',
              iconColor: '#10b981',
            });
          } catch (error) {
            console.error('Error generando PDF:', error);
            Swal.hideLoading();
            Swal.fire({
              title: 'Error',
              text: 'No se pudo generar el PDF',
              icon: 'error',
              background: '#0f1419',
              color: '#c8c8c8',
              confirmButtonColor: '#ef4444',
              iconColor: '#ef4444',
            });
          }
        },
      });
    } catch (error) {
      console.error('Error:', error);
      Swal.fire({
        title: 'Error',
        text: 'Error al exportar PDF',
        icon: 'error',
        background: '#0f1419',
        color: '#c8c8c8',
        confirmButtonColor: '#ef4444',
        iconColor: '#ef4444',
      });
    }
  });

  // Finalizar proyecto
  document.getElementById('finalizar-btn')?.addEventListener('click', async () => {
    const result = await Swal.fire({
      title: '¬øFinalizar proyecto?',
      text: 'Esto marcar√° el proyecto como inactivo',
      icon: 'question',
      showCancelButton: true,
      background: '#0f1419',
      color: '#c8c8c8',
      confirmButtonColor: '#667eea',
      cancelButtonColor: '#2d3746',
      confirmButtonText: 'S√≠, finalizar',
      cancelButtonText: 'Cancelar',
      iconColor: '#667eea',
    });

    if (result.isConfirmed) {
      try {
        await ProyectoService.cambiarEstado(proyectoHandlers.state.proyectoActual?.id || 0, false);
        await proyectoHandlers.loadProyecto();
        Swal.fire({
          title: '√âxito',
          text: 'Proyecto finalizado',
          icon: 'success',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#10b981',
          iconColor: '#10b981',
        });
      } catch (error) {
        Swal.fire({
          title: 'Error',
          text: 'No se pudo finalizar el proyecto',
          icon: 'error',
          background: '#0f1419',
          color: '#c8c8c8',
          confirmButtonColor: '#ef4444',
          iconColor: '#ef4444',
        });
      }
    }
  });

  // Evento para editar tareas
  document.addEventListener('edit-tarea', async (event: any) => {
    const tarea = event.detail.tarea;
    const viewModal = document.getElementById('view-tarea-modal')!;

    try {
      // Cerrar modal de visualizaci√≥n si est√° abierto
      if (viewModal.style.display === 'flex') {
        viewModal.style.display = 'none';
      }

      // Cambiar t√≠tulo del modal
      const modalTitle = document.getElementById('modal-title');
      if (modalTitle) {
        modalTitle.textContent = `Editar Tarea: ${tarea.titulo}`;
      }

      // Llenar formulario con datos de la tarea
      (document.getElementById('tarea-titulo') as HTMLInputElement).value = tarea.titulo;
      (document.getElementById('tarea-detalle') as HTMLTextAreaElement).value = tarea.detalle || '';
      (document.getElementById('tarea-que-falta') as HTMLTextAreaElement).value = tarea.que_falta || '';

      // Cargar d√≠as disponibles
      const proyecto = proyectoHandlers.state.proyectoActual;
      if (!proyecto) return;

      const dias = await TareaService.getDiasDisponibles(
        proyecto.id,
        proyecto.anio,
        proyecto.mes,
        tarea.id // Excluir esta tarea de los ocupados
      );

      // Actualizar mapas de d√≠as
      diasDisponibles.clear();
      diasSeleccionados.clear();

      dias.forEach((dia: any) => {
        const fechaFormato = new Date(dia.fecha).toLocaleDateString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          weekday: 'short',
        });

        diasDisponibles.set(dia.id, {
          id: dia.id,
          fecha: dia.fecha,
          texto: fechaFormato,
        });
      });

      // Cargar d√≠as seleccionados de la tarea actual
      if (tarea.dias && Array.isArray(tarea.dias)) {
        tarea.dias.forEach((dia: any) => {
          const fechaFormato = new Date(dia.fecha).toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            weekday: 'short',
          });

          diasSeleccionados.set(dia.id, {
            id: dia.id,
            fecha: dia.fecha,
            texto: fechaFormato,
          });
        });
      }

      // Actualizar UI
      actualizarSelectDias();
      renderizarDiasSeleccionados();

      // Cambiar bot√≥n submit a modo edici√≥n
      const submitBtn = form.querySelector<HTMLButtonElement>('button[type="submit"]');
      if (submitBtn) {
        submitBtn.textContent = 'Guardar cambios';
        submitBtn.dataset.editMode = 'true';
        submitBtn.dataset.tareaId = tarea.id.toString();
      }

      // Mostrar modal
      modal.style.display = 'flex';
    } catch (error) {
      console.error('Error editando tarea:', error);
      Swal.fire('Error', 'No se pudo cargar la tarea', 'error');
    }
  });

  // ========== MANEJO DE MESES ==========
  
  let mesesDisponibles: [number, number][] = [];
  const MESES_NOMBRES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

  /**
   * Carga los meses disponibles del proyecto
   */
  async function loadMeses() {
    try {
      if (!proyectoHandlers.state.proyectoActual) return;

      mesesDisponibles = await ProyectoService.getMeses(proyectoHandlers.state.proyectoActual.id);
      renderMeses();
    } catch (error) {
      console.error('Error cargando meses:', error);
    }
  }

  /**
   * Renderiza la lista de meses
   */
  function renderMeses() {
    const mesesList = document.getElementById('meses-list');
    if (!mesesList) return;

    if (mesesDisponibles.length === 0) {
      mesesList.innerHTML = '<div class="mes-item">Sin meses</div>';
      return;
    }

    mesesList.innerHTML = mesesDisponibles
      .map(([anio, mes]) => {
        const mesNombre = MESES_NOMBRES[mes - 1];
        const isActive = proyectoHandlers.state.proyectoActual?.anio === anio && 
                        proyectoHandlers.state.proyectoActual?.mes === mes;
        
        return `
          <div class="mes-item ${isActive ? 'active' : ''}" data-anio="${anio}" data-mes="${mes}">
            <span>${mesNombre} ${anio}</span>
            <span class="mes-badge">${anio}</span>
          </div>
        `;
      })
      .join('');

    // Agregar event listeners
    mesesList.querySelectorAll('.mes-item').forEach((element) => {
      element.addEventListener('click', async (e) => {
        const anio = parseInt(element.getAttribute('data-anio') || '0');
        const mes = parseInt(element.getAttribute('data-mes') || '0');

        if (anio > 0 && mes > 0) {
          // No cambiamos de proyecto, solo actualizamos los datos del mes
          // El proyecto original siempre tiene el mismo ID
          // Solo cambiamos qu√© mes/a√±o estamos viendo
          
          // Obtener el proyecto y actualizarlo
          if (proyectoHandlers.state.proyectoActual) {
            // Almacenamos qu√© mes estamos viendo
            const mesAnterior = `${proyectoHandlers.state.proyectoActual.anio}-${proyectoHandlers.state.proyectoActual.mes}`;
            const mesActual = `${anio}-${mes}`;
            
            // Cambiar el mes y a√±o del estado actual
            proyectoHandlers.state.proyectoActual.anio = anio;
            proyectoHandlers.state.proyectoActual.mes = mes;
            proyectoHandlers.state.mesActual = mes;
            proyectoHandlers.state.anioActual = anio;
            
            // Recargar datos
            await proyectoHandlers.loadDias();
            await proyectoHandlers.loadTareas();
            proyectoHandlers.updateTotalPanel();
            
            // Actualizar UI del header
            const periodoEl = document.getElementById('proyecto-periodo');
            if (periodoEl) {
              periodoEl.textContent = `${MESES_ES[mes as keyof typeof MESES_ES]} ${anio}`;
            }
            
            renderMeses();
            updateMesInfo();
          }
        }
      });
    });
  }

  /**
   * Actualiza la informaci√≥n del mes actual
   */
  function updateMesInfo() {
    const mesInfo = document.getElementById('mes-info');
    const mesInfoText = document.getElementById('mes-info-text');
    
    if (!proyectoHandlers.state.proyectoActual) return;

    const mesNombre = MESES_NOMBRES[proyectoHandlers.state.proyectoActual.mes - 1];
    const text = `${mesNombre} ${proyectoHandlers.state.proyectoActual.anio}`;
    
    if (mesInfoText) mesInfoText.textContent = text;
    if (mesInfo) mesInfo.style.display = 'block';
  }

  /**
   * Abre el modal para agregar mes
   */
  function openAddMesModal() {
    const modal = document.getElementById('add-mes-modal');
    if (modal) {
      modal.classList.add('show');

      // Pre-rellenar el a√±o y mes actual + 1
      const hoy = new Date();
      let proximoMes = hoy.getMonth() + 2; // +1 para siguiente mes, +1 para 0-indexed
      let proximoAnio = hoy.getFullYear();

      if (proximoMes > 12) {
        proximoMes = 1;
        proximoAnio++;
      }

      const yearInput = document.getElementById('nuevo-mes-year') as HTMLInputElement;
      const mesInput = document.getElementById('nuevo-mes-mes') as HTMLSelectElement;

      if (yearInput) yearInput.value = proximoAnio.toString();
      if (mesInput) mesInput.value = proximoMes.toString();
    }
  }

  /**
   * Cierra el modal para agregar mes
   */
  function closeAddMesModal() {
    const modal = document.getElementById('add-mes-modal');
    if (modal) {
      modal.classList.remove('show');
    }
  }

  // Event listeners para agregar mes
  document.getElementById('add-mes-btn')?.addEventListener('click', openAddMesModal);
  document.getElementById('close-add-mes')?.addEventListener('click', closeAddMesModal);

  // Cerrar al hacer click fuera del formulario
  document.getElementById('add-mes-modal')?.addEventListener('click', (e) => {
    if (e.target === document.getElementById('add-mes-modal')) {
      closeAddMesModal();
    }
  });

  // Manejar env√≠o del formulario
  document.getElementById('add-mes-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
      const anio = parseInt((document.getElementById('nuevo-mes-year') as HTMLInputElement).value);
      const mes = parseInt((document.getElementById('nuevo-mes-mes') as HTMLSelectElement).value);

      if (!anio || !mes) {
        Swal.fire('Error', 'Por favor seleccione un mes y a√±o v√°lidos', 'error');
        return;
      }

      // Verificar que no sea una fecha pasada
      const fechaSeleccionada = new Date(anio, mes - 1, 1);
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);

      if (fechaSeleccionada < hoy) {
        Swal.fire({
          title: '¬øDeseas continuar?',
          text: 'La fecha seleccionada es anterior a hoy.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'S√≠, agregar',
          cancelButtonText: 'Cancelar',
        }).then(async (result) => {
          if (result.isConfirmed) {
            await agregarMes(anio, mes);
          }
        });
      } else {
        await agregarMes(anio, mes);
      }
    } catch (error) {
      console.error('Error:', error);
      Swal.fire('Error', 'No se pudo agregar el mes', 'error');
    }
  });

  /**
   * Agrega un mes al proyecto
   */
  async function agregarMes(anio: number, mes: number) {
    try {
      if (!proyectoHandlers.state.proyectoActual) return;

      await ProyectoService.addMes(proyectoHandlers.state.proyectoActual.id, anio, mes);
      
      closeAddMesModal();
      Swal.fire('√âxito', 'Mes agregado correctamente', 'success');
      
      // Recargar meses
      await loadMeses();
    } catch (error) {
      console.error('Error agregando mes:', error);
      Swal.fire('Error', 'No se pudo agregar el mes', 'error');
    }
  }

  /**
   * Inicializa los meses despu√©s de cargar el proyecto
   */
  async function initMeses() {
    await loadMeses();
    updateMesInfo();
    
    // Actualizar nombre del sidebar
    const sidebarNombre = document.getElementById('proyecto-nombre-sidebar');
    if (sidebarNombre && proyectoHandlers.state.proyectoActual) {
      sidebarNombre.textContent = proyectoHandlers.state.proyectoActual.nombre;
    }
  }

  // Cargar proyecto
  proyectoHandlers.loadProyecto().then(() => {
    initMeses();
  });
</script>
    </div>
  </ProtectedRoute>
</BaseLayout>

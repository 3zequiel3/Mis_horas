---
/**
 * Componente de notificaciones en el navbar
 * - Muestra badge con contador de notificaciones no le√≠das
 * - Panel desplegable con lista de notificaciones
 * - Acciones: marcar como le√≠da, eliminar, ver todas
 */
---

<div class="notificaciones-container">
  <button class="notificaciones-btn" id="notificaciones-toggle" aria-label="Notificaciones">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
    </svg>
    <span class="notificaciones-badge" id="notificaciones-badge" style="display: none;">0</span>
  </button>

  <div class="notificaciones-panel" id="notificaciones-panel">
    <div class="notificaciones-header">
      <h3>Notificaciones</h3>
      <button class="btn-marcar-todas" id="marcar-todas-leidas" title="Marcar todas como le√≠das">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </button>
    </div>

    <div class="notificaciones-filtros">
      <button class="filtro-btn active" data-filtro="todas">Todas</button>
      <button class="filtro-btn" data-filtro="no-leidas">No le√≠das</button>
    </div>

    <div class="notificaciones-lista" id="notificaciones-lista">
      <div class="notificacion-loader">
        <div class="loader"></div>
        <p>Cargando notificaciones...</p>
      </div>
    </div>

    <div class="notificaciones-footer">
      <a href="/notificaciones" class="btn-ver-todas">Ver todas las notificaciones</a>
    </div>
  </div>
</div>

<style>
  .notificaciones-container {
    position: relative;
  }

  .notificaciones-btn {
    position: relative;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .notificaciones-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    color: var(--text-primary);
  }

  .notificaciones-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: #ef4444;
    color: white;
    font-size: 0.7rem;
    font-weight: bold;
    padding: 0.15rem 0.4rem;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
  }

  .notificaciones-panel {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    width: 380px;
    max-height: 500px;
    background: var(--bg-card);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    display: none;
    flex-direction: column;
    z-index: 1000;
    border: 1px solid rgba(102, 126, 234, 0.2);
  }

  .notificaciones-panel.active {
    display: flex;
  }

  .notificaciones-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .notificaciones-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  .btn-marcar-todas {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.4rem;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .btn-marcar-todas:hover {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
  }

  .notificaciones-filtros {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .filtro-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .filtro-btn:hover {
    background: rgba(102, 126, 234, 0.1);
  }

  .filtro-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .notificaciones-lista {
    flex: 1;
    overflow-y: auto;
    max-height: 350px;
  }

  .notificacion-loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    gap: 1rem;
  }

  .loader {
    border: 3px solid rgba(102, 126, 234, 0.1);
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .notificacion-item {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .notificacion-item:hover {
    background: rgba(102, 126, 234, 0.05);
  }

  .notificacion-item.no-leida {
    background: rgba(102, 126, 234, 0.08);
  }

  .notificacion-item.no-leida::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 60%;
    background: #667eea;
    border-radius: 0 4px 4px 0;
  }

  .notificacion-content {
    display: flex;
    gap: 0.75rem;
  }

  .notificacion-icon {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }

  .notificacion-icon.invitacion {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
  }

  .notificacion-icon.alerta {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
  }

  .notificacion-icon.recordatorio {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
  }

  .notificacion-icon.sistema {
    background: rgba(102, 126, 234, 0.15);
    color: #667eea;
  }

  .notificacion-body {
    flex: 1;
  }

  .notificacion-titulo {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
  }

  .notificacion-mensaje {
    color: var(--text-secondary);
    font-size: 0.85rem;
    line-height: 1.4;
    margin-bottom: 0.5rem;
  }

  .notificacion-fecha {
    color: var(--text-muted);
    font-size: 0.75rem;
  }

  .notificacion-acciones {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .notificacion-acciones button {
    padding: 0.35rem 0.75rem;
    font-size: 0.8rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-accion-primaria {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-accion-secundaria {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-secondary);
  }

  .btn-accion-primaria:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .btn-accion-secundaria:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .notificacion-vacia {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    gap: 1rem;
    color: var(--text-muted);
  }

  .notificacion-vacia svg {
    width: 60px;
    height: 60px;
    opacity: 0.3;
  }

  .notificaciones-footer {
    padding: 0.75rem 1.25rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .btn-ver-todas {
    display: block;
    text-align: center;
    color: #667eea;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-ver-todas:hover {
    color: #764ba2;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .notificaciones-panel {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      width: 100%;
      max-height: 100vh;
      border-radius: 0;
    }
  }
</style>

<script>
  import { NotificacionService } from '../services/notificaciones';
  import { InvitacionService } from '../services/invitaciones';
  import { AlertUtils } from '../utils/swal';
  import type { Notificacion } from '../types';

  let notificaciones: Notificacion[] = [];
  let filtroActual: 'todas' | 'no-leidas' = 'todas';

  // Referencias DOM
  const toggleBtn = document.getElementById('notificaciones-toggle');
  const panel = document.getElementById('notificaciones-panel');
  const badge = document.getElementById('notificaciones-badge');
  const lista = document.getElementById('notificaciones-lista');
  const marcarTodasBtn = document.getElementById('marcar-todas-leidas');
  const filtrosBtns = document.querySelectorAll('.filtro-btn');

  // Toggle panel
  toggleBtn?.addEventListener('click', async (e) => {
    e.stopPropagation();
    const isActive = panel?.classList.toggle('active');
    
    if (isActive) {
      await cargarNotificaciones();
    }
  });

  // Cerrar al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!panel?.contains(e.target as Node) && !toggleBtn?.contains(e.target as Node)) {
      panel?.classList.remove('active');
    }
  });

  // Filtros
  filtrosBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filtrosBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filtroActual = btn.getAttribute('data-filtro') as 'todas' | 'no-leidas';
      renderizarNotificaciones();
    });
  });

  // Marcar todas como le√≠das
  marcarTodasBtn?.addEventListener('click', async () => {
    try {
      await NotificacionService.marcarTodasComoLeidas();
      notificaciones = notificaciones.map(n => ({ ...n, leida: true }));
      renderizarNotificaciones();
      actualizarBadge();
      AlertUtils.toast('Notificaciones marcadas como le√≠das', 'success');
    } catch (error) {
      console.error('Error al marcar como le√≠das:', error);
      AlertUtils.toast('Error al marcar notificaciones', 'error');
    }
  });

  // Cargar contador inicial
  async function cargarContador() {
    try {
      const contador = await NotificacionService.obtenerContador();
      if (badge) {
        badge.textContent = contador.toString();
        badge.style.display = contador > 0 ? 'block' : 'none';
      }
    } catch (error) {
      console.error('Error al cargar contador:', error);
    }
  }

  // Cargar notificaciones
  async function cargarNotificaciones() {
    if (!lista) return;

    try {
      const { notificaciones: data } = await NotificacionService.obtenerNotificaciones(false, 20);
      notificaciones = data;
      renderizarNotificaciones();
      actualizarBadge();
    } catch (error) {
      console.error('Error al cargar notificaciones:', error);
      lista.innerHTML = `
        <div class="notificacion-vacia">
          <p>Error al cargar notificaciones</p>
        </div>
      `;
    }
  }

  // Renderizar notificaciones
  function renderizarNotificaciones() {
    if (!lista) return;

    const notificacionesFiltradas = filtroActual === 'no-leidas'
      ? notificaciones.filter(n => !n.leida)
      : notificaciones;

    if (notificacionesFiltradas.length === 0) {
      lista.innerHTML = `
        <div class="notificacion-vacia">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <p>${filtroActual === 'no-leidas' ? 'No hay notificaciones nuevas' : 'No hay notificaciones'}</p>
        </div>
      `;
      return;
    }

    lista.innerHTML = notificacionesFiltradas.map(n => crearNotificacionHTML(n)).join('');

    // Agregar event listeners
    notificacionesFiltradas.forEach(n => {
      const item = document.getElementById(`notif-${n.id}`);
      item?.addEventListener('click', () => marcarComoLeida(n.id));

      // Acciones de invitaci√≥n
      if (n.tipo === 'invitacion_proyecto' && n.metadata?.token) {
        const aceptarBtn = document.getElementById(`aceptar-${n.id}`);
        const rechazarBtn = document.getElementById(`rechazar-${n.id}`);

        aceptarBtn?.addEventListener('click', (e) => {
          e.stopPropagation();
          aceptarInvitacion(n.metadata!.token, n.id);
        });

        rechazarBtn?.addEventListener('click', (e) => {
          e.stopPropagation();
          rechazarInvitacion(n.metadata!.token, n.id);
        });
      }
    });
  }

  // Crear HTML de notificaci√≥n
  function crearNotificacionHTML(n: Notificacion): string {
    const iconos: Record<string, string> = {
      invitacion: 'üì®',
      invitacion_proyecto: 'üì®',
      invitacion_aceptada: '‚úÖ',
      invitacion_rechazada: '‚ùå',
      alerta: '‚ö†Ô∏è',
      alerta_deuda: '‚ö†Ô∏è',
      alerta_exceso_horario: '‚ö†Ô∏è',
      recordatorio: '‚è∞',
      recordatorio_marcado: '‚è∞',
      sistema: '‚ÑπÔ∏è',
      justificacion_enviada: 'üìù',
      justificacion_aprobada: '‚úÖ',
      justificacion_rechazada: '‚ùå',
      salida_automatica: 'üö™',
      confirmacion_horas_extras: '‚è±Ô∏è'
    };

    const fecha = new Date(n.fecha_creacion);
    const fechaRelativa = obtenerFechaRelativa(fecha);

    const accionesHTML = n.tipo === 'invitacion_proyecto' && n.metadata?.token && !n.leida
      ? `
        <div class="notificacion-acciones">
          <button class="btn-accion-primaria" id="aceptar-${n.id}">Aceptar</button>
          <button class="btn-accion-secundaria" id="rechazar-${n.id}">Rechazar</button>
        </div>
      `
      : '';

    return `
      <div class="notificacion-item ${!n.leida ? 'no-leida' : ''}" id="notif-${n.id}">
        <div class="notificacion-content">
          <div class="notificacion-icon ${n.tipo}">
            ${iconos[n.tipo]}
          </div>
          <div class="notificacion-body">
            <div class="notificacion-titulo">${n.titulo}</div>
            <div class="notificacion-mensaje">${n.mensaje}</div>
            <div class="notificacion-fecha">${fechaRelativa}</div>
            ${accionesHTML}
          </div>
        </div>
      </div>
    `;
  }

  // Marcar como le√≠da
  async function marcarComoLeida(id: number) {
    const notif = notificaciones.find(n => n.id === id);
    if (!notif || notif.leida) return;

    try {
      await NotificacionService.marcarComoLeida(id);
      notif.leida = true;
      renderizarNotificaciones();
      actualizarBadge();
    } catch (error) {
      console.error('Error al marcar como le√≠da:', error);
    }
  }

  // Aceptar invitaci√≥n
  async function aceptarInvitacion(token: string, notifId: number) {
    try {
      await InvitacionService.aceptarInvitacion(token);
      AlertUtils.toast('Invitaci√≥n aceptada correctamente', 'success');
      
      // Marcar como le√≠da y recargar
      await marcarComoLeida(notifId);
      await cargarNotificaciones();
      
      // Recargar la p√°gina para actualizar proyectos
      setTimeout(() => window.location.reload(), 1500);
    } catch (error) {
      console.error('Error al aceptar invitaci√≥n:', error);
      AlertUtils.toast('Error al aceptar la invitaci√≥n', 'error');
    }
  }

  // Rechazar invitaci√≥n
  async function rechazarInvitacion(token: string, notifId: number) {
    const result = await AlertUtils.prompt(
      'Rechazar invitaci√≥n',
      'Indica el motivo (opcional):',
      'text',
      'No puedo en este momento'
    );

    if (result.isConfirmed) {
      try {
        await InvitacionService.rechazarInvitacion(token, result.value);
        AlertUtils.toast('Invitaci√≥n rechazada', 'info');
        await marcarComoLeida(notifId);
        await cargarNotificaciones();
      } catch (error) {
        console.error('Error al rechazar invitaci√≥n:', error);
        AlertUtils.toast('Error al rechazar la invitaci√≥n', 'error');
      }
    }
  }

  // Actualizar badge
  function actualizarBadge() {
    const noLeidas = notificaciones.filter(n => !n.leida).length;
    if (badge) {
      badge.textContent = noLeidas.toString();
      badge.style.display = noLeidas > 0 ? 'block' : 'none';
    }
  }

  // Obtener fecha relativa
  function obtenerFechaRelativa(fecha: Date): string {
    const ahora = new Date();
    const diff = ahora.getTime() - fecha.getTime();
    const minutos = Math.floor(diff / 60000);
    const horas = Math.floor(minutos / 60);
    const dias = Math.floor(horas / 24);

    if (minutos < 1) return 'Ahora';
    if (minutos < 60) return `Hace ${minutos} min`;
    if (horas < 24) return `Hace ${horas}h`;
    if (dias < 7) return `Hace ${dias}d`;
    return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
  }

  // Cargar contador inicial
  cargarContador();

  // Actualizar contador cada 30 segundos
  setInterval(cargarContador, 30000);
</script>
